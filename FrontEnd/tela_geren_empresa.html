<html>
<header>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="layout.css">

</header>
<body>
    <div class="container">
        <div class="row" style="height: 95%">
            <div class="col s12" style="background-color: #000055">
                <p style="color: white; text-align: center; height: 25px">Empresas</p>
            </div>
            <div id="sucesso" class="col s6" style="background-color: white;height: 95%;overflow-y: scroll;">
                <!-- bloco das empresas  -->
            </div>

            <div class="col s6" id="formTelaEmpresa" style="background-color: darkgray;height: 95%"/>
                <button class="open-button" onclick="openForm()">Cadastrar Empresa</button>
                <div class="form-popup" id="myForm" name="myForm">
                    <form name="myForm" id="myForm" method="post" onsubmit="return validar()" class="form-container">
                        <h1 style="text-align: center; font-size:20px;" >Cadastrar Empresa  </h1>

                        <input id="cliName" type="text" placeholder="Nome da empresa"/>
                        <input id="cliCnpj" type="text" maxlength="18"  OnKeyPress="formatar('##.###.###/####-##', this)" placeholder="CNPJ"/>

                        <input id="cliTelEmp" type="text" maxlength="12" OnKeyPress="formatar('##-####-####', this)" placeholder="Tel. primário (Ex: 99-9999-9999)"/> 
                        <input id="cliTelCel" type="text" maxlength="13" OnKeyPress="formatar('##-#####-####', this)" placeholder="Tel. secundário (Ex: 99-99999-9999)"/>

                        <input id="cliEmail" type="text" placeholder="E-mail"/>
                        <input id="cliCont" type="text" placeholder="Contato(Responsável)"/>
                        <input id="cliEnd" type="text" placeholder="Endereço"/>

                        <input id="cliPass" type="password" placeholder="Senha"/>
                        <input id="cliPass2" type="password" placeholder="Confirmar senha"/>

                        <button type="submit" class="btn" style="text-align:center;">Cadastrar</button>
                        <button type="button" class="btn cancel" onclick="closeForm()" style="text-align:center;">Fechar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="container col s6" style="background-color: #000055; height: 55px; padding: 1px;">
        <div class="container" style="text-align: center;">
        <p style="color: white">
             © 2018 Desenvolvido por alunos da FATEC-SP
        </p>    
        </div>
    </div>
</body>

<script>
    function formatar(mascara, documento) {
        var i = documento.value.length;
        var saida = mascara.substring(0, 1);
        var texto = mascara.substring(i)

        if (texto.substring(0, 1) != saida) {
            documento.value += texto.substring(0, 1);
        }
    }

    function validar() {        
        if(document.myForm.cliName.value=="" || document.myForm.cliName.value.length < 4){
			alert( "Preencha campo NOME corretamente!" );
			document.myForm.cliName.focus();
			return false;
		}
		if(document.myForm.cliCnpj.value=="" || document.myForm.cliCnpj.value.length < 11){
			alert( "Preencha campo CNPJ corretamente!" );
			document.myForm.cliCnpj.focus();
			return false;
		}
		if(document.myForm.cliTelEmp.value=="" || document.myForm.cliTelEmp.value.length < 12){
			alert( "Preencha campo Telefone corretamente!" );
			document.myForm.cliTelEmp.focus();
			return false;
		}
		if(document.myForm.cliTelCel.value=="" || document.myForm.cliTelCel.value.length < 13){
			alert( "Preencha campo TELEFONE corretamente!" );
			document.myForm.cliTelCel.focus();
			return false;
		}
		if(document.myForm.cliEmail.value=="" || document.myForm.cliEmail.value.indexOf('@')==-1 || document.myForm.cliEmail.value.indexOf('.')==-1){
			alert( "Preencha campo EMAIL corretamente!" );
			document.myForm.cliEmail.focus();
			return false;
		}
		if(document.myForm.cliCont.value=="" || document.myForm.cliCont.value.length < 4){
			alert( "Preencha campo CONTATO corretamente!" );
			document.myForm.cliCont.focus();
			return false;
		}
		if(document.myForm.cliEnd.value=="" || document.myForm.cliEnd.value.length < 4){
			alert( "Preencha campo ENDEREÇO corretamente!" );
			document.myForm.cliEnd.focus();
			return false;
		}
		if(document.myForm.cliPass.value != document.myForm.cliPass2.value || document.myForm.cliPass.value=="" || document.myForm.cliPass2.value=="" ){ 
             alert("SENHAS DIFERENTES! DIGITAR SENHAS IGUAIS");
             return false;
        }
		else{
		return registraCliente();
		}
    }
	
	function openForm() {
        document.getElementById("myForm").style.display = "block";
    }

    function closeForm() {
        document.getElementById("myForm").style.display = "none";
    }

    function removeCE(value)
    {
        var listaParaRemover = ['.',',','/','\\','-'];

        for(var item in listaParaRemover)
        {
            var location = value.indexOf(listaParaRemover[item]);
            while(location > -1)
            {
                value = value.replace(listaParaRemover[item], "");
                location = value.indexOf(listaParaRemover[item]);
            }
        }

        return value;
    }

    function deleteCliente(cnpj)
    {
        $.ajax({
            url: 'http://apiengsoft.ddns.net:8081/api/cliente/'+cnpj,
            type: 'delete',
            success: function (result) {
                if(result != "false")
                {
                    return deleteUsuario(cnpj);
                }
                else
                {
                    alert("Não foi possivel deletar o cliente.");
                }
            }
        });
    };

    function deleteUsuario(cnpj)
    {
        $.ajax({
            url: 'http://apiengsoft.ddns.net:8081/api/usuario/'+cnpj,
            type: 'delete',
            success: function (result) {
                if(result != "false")
                {
                    alert("Funcionario deletado!");
                    getFuncionario();
                }
                else
                {
                    alert("Não foi possivel deletar o cliente.");
                }
            }
        });
    };

    function registraUsuario(user, name, password, type, rank)
    {
        var User = {
            Id: user,
            Nome: name,
            Senha: password,
            Tipo: type,
            Classe: rank
        }

        $.ajax({
            url: 'http://apiengsoft.ddns.net:8081/api/usuario',
            type: 'post',
            dataType: 'text',
            contentType: 'application/json',
            success: function (data) {
                if(data != "false")
                {
                    alert("Empresa registrada");
                    closeForm();
                }
            },
            error: function(data)
            {
                alert("Não foi possivel cadastrar a empresa, tente novamente mais tarde");
            },
            data: JSON.stringify(User)
        });
    }

    function registraCliente() {
        var cliName = document.getElementById("cliName").value;
        var cliCnpj = removeCE(document.getElementById("cliCnpj").value);
        var cliTelEmp = removeCE(document.getElementById("cliTelEmp").value);
		var cliTelCel = removeCE(document.getElementById("cliTelCel").value);
        var cliEmail = document.getElementById("cliEmail").value;
		var cliCont = document.getElementById("cliCont").value;
        var cliEnd = document.getElementById("cliEnd").value;
        var cliPass = document.getElementById("cliPass").value;

        var cli = {
            EmpNome: cliName,
			Cnpj: cliCnpj,
            TelEmp: cliTelEmp,
			TelCel: cliTelCel,
			Contato: cliCont,
            Email: cliEmail,
            EmpEnd: cliEnd
        }

        $.ajax({
            url: 'http://apiengsoft.ddns.net:8081/api/cliente',
            type: 'post',
            dataType: 'text',
            contentType: 'application/json',
            success: function (data) {
                if(data != "false")
                {
                    return registraUsuario(cliCnpj, cliName, cliPass, 2, 1);
                }
                else
                {
                    alert("Não foi possivel cadastrar a empresa, tente novamente mais tarde");
                }
            },
            error: function(data)
            {
                alert("Não foi possivel cadastrar a empresa, tente novamente mais tarde");
            },
            data: JSON.stringify(cli)
        });
    
        return false;
    };
	
		function getCliente() {

		var cliente = [];

        $.getJSON("http://apiengsoft.ddns.net:8081/api/cliente", function(data){

        	$.each(data, function(i, object){
        		cliente.push({
        				EmpNome: object.EmpNome,
    					Cnpj: object.Cnpj,
					    TelEmp: object.TelEmp,
						TelCel: object.TelCel,
					    Email: object.Email,
						Contato: object.Contato,
					    EmpEnd: object.EmpEnd
    			});
        	});

			for (var i = 0; i < cliente.length; i++ ) {
			    document.getElementById("sucesso").innerHTML += 
						    '<div class="card-content-black-text">' + 
							    '<span class="card-title"><span class="step">Cliente: ' + cliente[i].EmpNome + '</span></span>' +
						    	'<div class="block-with-text"><b>CNPJ: </b>'+ cliente[i].Cnpj + '</div>' +
								'<div class="block-with-text"><b>Tel.primário:</b> ' + cliente[i].TelEmp + '</div>'+
								'<div class="block-with-text"><b>Tel.secundário:</b> ' + cliente[i].TelCel + '</div>'+
								'<div class="block-with-text"><b>E-mail: </b>'+ cliente[i].Email + '</div>'+
								'<button id="removerDiv" onclick="return deleteCliente('+ cliente[i].Cnpj +')" type="button">Deletar</button> <button id="removerDiv1" onclick="return alteraCliente('+ cliente[i].Cnpj +')" type="button">Alterar</button>'+
							 '</div>';
			}
		})
    };

    function getCookie(cname) {
        var name = cname + "=";
        var decodedCookie = decodeURIComponent(document.cookie);
        var ca = decodedCookie.split(';');
        for(var i = 0; i <ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    };

    if(getCookie("Autorized") == "" || getCookie("Type") != 1)
    {
        alert("Você não tem acesso a essa area, contate o administrador");
        window.location.replace('./index.html');
    }
</script>
<script>getCliente();</script>
</html>