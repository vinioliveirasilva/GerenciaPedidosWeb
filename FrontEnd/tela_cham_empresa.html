<html>
<header>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <link rel="stylesheet" type="text/css" href="layout.css">
</header>
<head>

</head>
<body>
    <div class="container">
        <div class="row" style="height: 95%">
            <div class="col s12" style="background-color: #000055;" >
                <p style="color: white; text-align: center; height: 25px">Chamados</p>
            </div>
            <div id="sucesso" class="col s12" style="background-color: white;height: 95%;overflow-y: scroll;">
                <button class="open-button" onclick="openForm()">Abrir chamado</button>
                <button class="leave-button" onclick="Logout()">Sair</button>
                <div class="form-popup" id="myForm">
                    <form id="myForm" name="myForm" method="post" onsubmit="return validar()" class="form-container">
                        <h1 style="text-align: center; font-size:20px;"> Abrir chamado</h1>
                        
                        <label for="data" style="font-size:20px;">Data de abertura:</label>
                        <input type="text" id="theDate" disabled>
                        
                        <label for="Titulo" style="font-size:20px;">Título:</label>
                        <input id="chamTitulo" type="text" placeholder="Título" />
                        
                        <label for="Problema" rows="5" style="font-size:20px">Problema:</label>
                        <textarea id="chamProb" placeholder="Problema" cols="40" rows="5"></textarea>

                        <button type="submit" value="submit" class="btn"  style="text-align:center;">Enviar</button>
                        <button type="button" class="btn cancel" onclick="closeForm()" style="text-align:center;">Fechar</button>
                    </form>
                </div>
                <!-- bloco dos chamados  -->
			</div>
    </div>
    <div class="container" style="background-color: #000055; height: 25px; padding: 1px; position:fixed; bottom:0; ">
        <div class="container" style="text-align: center;">
             <p style="color: white">© 2018 Desenvolvido por alunos da FATEC-SP</p>
         </div>
    </div>
</div>

    
</body>

<script>
	$(document).ready(function() {
		var date = new Date();

		var day = date.getDate();
		var month = date.getMonth() + 1;
		var year = date.getFullYear();

		if (month < 10) month = "0" + month;
		if (day < 10) day = "0" + day;

		var today = day + "-" + month + "-" + year;       
		$("#theDate").attr("value", today);
	});

     function validar() {
        if(document.myForm.chamTitulo.value=="" || document.myForm.chamTitulo.value.length < 5){
			alert( "Especificar o TITULO!" );
			document.myForm.chamTitulo.focus();
			return false;
		}
		if(document.myForm.chamProb.value=="" || document.myForm.chamProb.value.length < 7){
			alert( "Especificar o PROBLEMA!" );
			document.myForm.chamProb.focus();
			return false;
		}
		else{
		return registraChamado();
		}
    };

    function openForm() {
        document.getElementById("myForm").style.display = "block";
    };

    function closeForm() {
        document.getElementById("myForm").style.display = "none";
    };

    function registraChamado() {
        var chamTitulo = document.getElementById("chamTitulo").value;
        var chamProb = document.getElementById("chamProb").value;		
		var theDate = document.getElementById("theDate").value;		

        var cham = {
            Titulo: chamTitulo,
			Problema: chamProb,
			Data_Abertura: theDate,
            Status: 1,
            Prioridade: 0
        }

        $.ajax({
            url: 'http://apiengsoft.ddns.net:8081/api/chamado',
            type: 'post',
            dataType: 'text',
            contentType: 'application/json',
            success: function (data) {
                alert("Chamado cadastrado");
				document.location.reload(true);
                closeForm();
            },
            data: JSON.stringify(cham)
        });
    
        return false;
    };
	
		function getChamado(){

		var chamado = [];
		var StatusText = Object.freeze({0:"Indeterminado" ,1:"Em aberto", 2:"Em progresso", 3:"Concluido", 4:"Interrompido"});

        $.getJSON("http://apiengsoft.ddns.net:8081/api/chamado", function(data){

        	$.each(data, function(i, object){
        		chamado.push({
						Status: object.Status,
        				Titulo: object.Titulo,
    					Problema: object.Problema,
						Data_Abertura: object.Data_Abertura,
						Data_Fechamento: object.Data_Fechamento
				});
        	});

			for (var i = 0; i < chamado.length; i++ ) {
			    document.getElementById("sucesso").innerHTML += 
						    '<div class="card-content-black-text">' + 
							    '<span class="card-title"><span class="step" style="width: 100%">Título: ' + chamado[i].Titulo + '</span></span>' +
								'<div><b>Status: </b>' + StatusText[chamado[i].Status] + '</div>'  +
								'<div><b>Aberto em: </b> ' + chamado[i].Data_Abertura + '</div>'+
								'<div><b>Fechado em: </b> ' + chamado[i].Data_Fechamento + '</div>'+
								'<div><b>Problema: </b>'+ chamado[i].Problema + '</div>' +
							'</div>';
			}
		})
    };

   function Logout()
    {
        setCookie("User", "", 20);
          setCookie("Type", -1, 20);
          setCookie("Autorized", "false", 20);
          setCookie("Rank", -1, 20);
        window.location.replace('./index.html');
    }

    function setCookie(cname,cvalue,exdays) {
    var d = new Date();
    d.setTime(d.getTime() + (exdays*60*1000));
    var expires = "expires=" + d.toGMTString();
    document.cookie = cname + "=" + cvalue + ";" + expires + ",path=/";
}

    function getCookie(cname) {
        var name = cname + "=";
        var decodedCookie = decodeURIComponent(document.cookie);
        var ca = decodedCookie.split(';');
        for(var i = 0; i <ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    };

    if(getCookie("Autorized") == "" || getCookie("Type") != 2)
    {
        alert("Você não tem acesso a essa area, contate o administrador");
        window.location.replace('./index.html');
    }
</script>
<script>getChamado();</script>
</html>